var Q=Object.defineProperty;var o=(t,e)=>Q(t,"name",{value:e,configurable:!0});import{h as x,_ as B,c as Z}from"./plugin-vueexport-helper-dbf55845.js";import{d as z,o as h,a as f,b as p,i as v,e as D,t as g,k as X,n as ee,F as S,r as N,g as $,j as I}from"./vue.esm-bundler-398966a3.js";import{V as te}from"./ViewEntry-61975da8.js";import"./i18n-c4b3ca93.js";import"./ViewingModal-2336206d.js";var q={},se={get exports(){return q},set exports(t){q=t}};function F(){}o(F,"E");F.prototype={on:function(t,e,s){var r=this.e||(this.e={});return(r[t]||(r[t]=[])).push({fn:e,ctx:s}),this},once:function(t,e,s){var r=this;function n(){r.off(t,n),e.apply(s,arguments)}return o(n,"listener"),n._=e,this.on(t,n,s)},emit:function(t){var e=[].slice.call(arguments,1),s=((this.e||(this.e={}))[t]||[]).slice(),r=0,n=s.length;for(r;r<n;r++)s[r].fn.apply(s[r].ctx,e);return this},off:function(t,e){var s=this.e||(this.e={}),r=s[t],n=[];if(r&&e)for(var a=0,d=r.length;a<d;a++)r[a].fn!==e&&r[a].fn._!==e&&n.push(r[a]);return n.length?s[t]=n:delete s[t],this}};se.exports=F;var re=q.TinyEmitter=F;const k=new re,V=z({name:"UploadEntry",props:{file:{type:File,required:!0},baseUrl:{type:String,required:!0},maxSize:{type:Number,default:0},mimetypes:{type:Array,default:()=>[]},automatic:{type:Boolean,default:!0}},emits:{setToken(t){return t.length>0},delete(){return!0}},data(){return{progress:0,token:"",error:""}},computed:{isImage:function(){return this.file.type.split("/")[0]==="image"},fileUrl:function(){return URL.createObjectURL(this.file)},humanizedSize:function(){return x(this.file.size)}},mounted(){this.maxSize&&this.file.size>this.maxSize?this.error=this.$t("upload_entry.too_large"):this.mimetypes.length&&!this.mimetypes.includes(this.file.type)?this.error=this.$tc("upload_entry.wrong_type",this.mimetypes.length,{types:this.mimetypes.join(", ")}):this.automatic?this.sendFile():k.on("upload",this.sendFile)},methods:{revokeUrl:function(t){URL.revokeObjectURL(t)},sendFile:function(){const t=new XMLHttpRequest;t.upload.addEventListener("progress",s=>{this.progress=Math.round(s.loaded*100/s.total)},!1),t.open("POST",`${this.baseUrl}request-upload`,!0),t.addEventListener("readystatechange",()=>{if(t.readyState===4&&t.status>=200&&t.status<=300){const s=JSON.parse(t.responseText);this.$emit("setToken",s.token)}else{let s;try{s=JSON.parse(t.responseText).detail}catch{s=t.statusText}this.error=this.$t("request_error",{error:s})}});const e=new FormData;e.append("file",this.file),t.send(e)}}}),ne={class:"media"},ie={key:0,class:"media-left"},ae=["src","alt"],oe={class:"media-body"},le={class:"media-heading"},de={class:"text-nowrap"},ue={key:0,class:"progress"},he=["aria-valuenow"],pe={class:"sr-only"},ce={key:1,class:"text-danger"},fe={class:"media-right"},me=p("span",{class:"fas fa-trash-alt"},null,-1),ge=[me];function ye(t,e,s,r,n,a){return h(),f("li",ne,[t.isImage?(h(),f("div",ie,[p("img",{class:"media-object img-thumbnail",src:t.fileUrl,alt:t.file.name,width:"80",onLoad:e[0]||(e[0]=d=>t.revokeUrl(t.fileUrl))},null,40,ae)])):v("",!0),p("div",oe,[p("h4",le,[D(g(t.file.name)+" ",1),p("small",null,[p("span",de,g(t.humanizedSize),1),D(" ("+g(t.file.type)+")",1)])]),t.error?(h(),f("span",ce,g(t.error),1)):(h(),f("div",ue,[p("div",{class:"progress-bar progress-bar-striped active",role:"progressbar","aria-valuenow":t.progress,"aria-valuemin":"0","aria-valuemax":"100",style:X({width:`${t.progress}%`})},[p("span",pe,g(t.$t("upload_entry.completion",{progress:t.progress})),1)],12,he)]))]),p("div",fe,[p("button",{type:"button",class:"btn btn-danger",onClick:e[1]||(e[1]=d=>t.$emit("delete"))},ge)])])}o(ye,"_sfc_render$1");const Ee=B(V,[["render",ye]]);V.__docgenInfo={displayName:"UploadEntry",exportName:"default",description:"",tags:{},props:[{name:"file",type:{name:"File"},required:!0},{name:"baseUrl",type:{name:"string"},required:!0},{name:"maxSize",type:{name:"number"},defaultValue:{func:!1,value:"0"}},{name:"mimetypes",type:{name:"array"},defaultValue:{func:!1,value:"[]"}},{name:"automatic",type:{name:"boolean"},defaultValue:{func:!1,value:"true"}}],events:[{name:"delete"},{name:"setToken",type:{names:["undefined"]}}],sourceFiles:["/home/runner/work/osis-document/osis-document/frontend/components/UploadEntry.vue"]};const _e="osisdocument:",be="add",ve="delete",j=z({name:"DocumentUploader",components:{UploadEntry:Ee,ViewEntry:te},props:{name:{type:String,required:!0},baseUrl:{type:String,required:!0},uploadText:{type:String,default:null},uploadButtonText:{type:String,default:null},maxSize:{type:Number,default:0},automaticUpload:{type:Boolean,default:!0},editableFilename:{type:Boolean,default:!0},values:{type:Array,default:()=>[]},mimetypes:{type:Array,default:()=>[]},minFiles:{type:Number,default:0},maxFiles:{type:Number,default:0}},data(){let t=0;return{isDragging:!1,fileList:{},tokens:Object.fromEntries(this.values.map(e=>(t++,[t,e]))),indexGenerated:t}},computed:{filteredTokens:function(){return Object.fromEntries(Object.entries(this.tokens).filter(t=>!!t[1]))},cleanedTokens:function(){return Object.fromEntries(Object.entries(this.tokens).filter(t=>!!t[1]&&!["FileInfectedException","UploadInvalidException"].includes(t[1])))},nbUploadedFiles:function(){return Object.values(this.cleanedTokens).length},dragNDropLabel:function(){return this.minFiles?this.minFiles===this.maxFiles?this.$tc("uploader.specific_nb_drag_n_drop_label",this.minFiles):this.maxFiles?this.$t("uploader.min_max_drag_n_drop_label",{min:this.minFiles,max:this.maxFiles}):this.$tc("uploader.min_drag_n_drop_label",this.minFiles):this.maxFiles?this.$tc("uploader.max_drag_n_drop_label",this.maxFiles):this.$t("uploader.drag_n_drop_label")}},watch:{cleanedTokens:{handler(t,e){if(JSON.stringify(e)!==JSON.stringify(t)){const s=Object.keys(e).length>Object.keys(t).length?ve:be,r=new CustomEvent(_e+s,{bubbles:!0,detail:{newTokens:t,oldTokens:e}});this.$el.dispatchEvent(r)}}}},mounted(){jQuery("> input",this.$el).on("change",t=>{jQuery(t.target).val()||(this.tokens={})})},methods:{humanizedSize:x,triggerUpload(){k.emit("upload")},onFilePicked(t){const e=t.target.files;e&&Array.from(e).forEach(s=>{this.indexGenerated++,this.fileList[this.indexGenerated]=s,this.tokens[this.indexGenerated]=null}),this.isDragging=!1}}});const Se=["accept"],Re=p("span",{class:"glyphicon glyphicon-plus"},null,-1),De={key:0},Te={key:1,class:"media-list"},Ne={key:2,class:"text-right form-group"},we={class:"media-list"},qe=["name","value"];function He(t,e,s,r,n,a){const d=I("UploadEntry"),c=I("ViewEntry");return h(),f(S,null,[t.maxFiles===0||t.nbUploadedFiles<t.maxFiles?(h(),f("div",{key:0,class:ee(["dropzone form-group",{hovering:t.isDragging}]),onDragenter:e[3]||(e[3]=u=>t.isDragging=!0)},[p("input",{ref:"fileInput",type:"file",multiple:"",accept:t.mimetypes.length?t.mimetypes.join(","):void 0,onDragleave:e[0]||(e[0]=u=>t.isDragging=!1),onChange:e[1]||(e[1]=(...u)=>t.onFilePicked&&t.onFilePicked(...u))},null,40,Se),D(" "+g(t.uploadText||t.dragNDropLabel)+" ",1),p("button",{class:"btn btn-default",type:"button",onClick:e[2]||(e[2]=u=>t.$refs.fileInput.click())},[Re,D(" "+g(t.uploadButtonText||t.$t("uploader.add_file_label")),1)]),t.maxSize?(h(),f("span",De,g(t.$t("uploader.max_size_label",{size:t.humanizedSize(t.maxSize)})),1)):v("",!0)],34)):v("",!0),t.fileList?(h(),f("ul",Te,[(h(!0),f(S,null,N(t.fileList,(u,l)=>(h(),$(d,{key:l,file:u,"base-url":t.baseUrl,"max-size":t.maxSize,mimetypes:t.mimetypes,automatic:t.automaticUpload,onDelete:y=>{delete t.fileList[l],delete t.tokens[l]},onSetToken:y=>{t.tokens[l]=y,delete t.fileList[l]}},null,8,["file","base-url","max-size","mimetypes","automatic","onDelete","onSetToken"]))),128))])):v("",!0),!t.automaticUpload&&Object.values(t.fileList).length?(h(),f("div",Ne,[p("button",{class:"btn btn-default",type:"button",onClick:e[4]||(e[4]=(...u)=>t.triggerUpload&&t.triggerUpload(...u))},g(t.$t("uploader.trigger_upload")),1)])):v("",!0),p("ul",we,[(h(!0),f(S,null,N(t.filteredTokens,(u,l)=>(h(),$(c,{id:`${t.name}-${l}`,key:l,value:u,"base-url":t.baseUrl,editable:!0,"editable-filename":t.editableFilename,onDelete:y=>delete t.tokens[l],onUpdateToken:y=>t.tokens[l]=y},null,8,["id","value","base-url","editable-filename","onDelete","onUpdateToken"]))),128))]),(h(!0),f(S,null,N(Object.values(t.cleanedTokens),(u,l)=>(h(),f("input",{key:`${t.name}_${l}`,type:"hidden",name:`${t.name}_${l}`,value:u},null,8,qe))),128))],64)}o(He,"_sfc_render");const G=B(j,[["render",He]]);j.__docgenInfo={displayName:"DocumentUploader",exportName:"default",description:"",tags:{},props:[{name:"name",type:{name:"string"},required:!0},{name:"baseUrl",type:{name:"string"},required:!0},{name:"uploadText",type:{name:"string"},defaultValue:{func:!1,value:"null"}},{name:"uploadButtonText",type:{name:"string"},defaultValue:{func:!1,value:"null"}},{name:"maxSize",type:{name:"number"},defaultValue:{func:!1,value:"0"}},{name:"automaticUpload",type:{name:"boolean"},defaultValue:{func:!1,value:"true"}},{name:"editableFilename",type:{name:"boolean"},defaultValue:{func:!1,value:"true"}},{name:"values",type:{name:"array"},defaultValue:{func:!1,value:"[]"}},{name:"mimetypes",type:{name:"array"},defaultValue:{func:!1,value:"[]"}},{name:"minFiles",type:{name:"number"},defaultValue:{func:!1,value:"0"}},{name:"maxFiles",type:{name:"number"},defaultValue:{func:!1,value:"0"}}],sourceFiles:["/home/runner/work/osis-document/osis-document/frontend/DocumentUploader.vue"]};/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class E{constructor(e){this._headers=new Map,e&&(e instanceof E?this._headers=new Map(e._headers):Object.entries(e).forEach(([s,r])=>this.addHeader(s,r)))}reset(){return this._headers.clear(),this}getHeader(e){return this._headers.get(e.toUpperCase())??null}getAll(){return[...this._headers.keys()].sort().reduce((r,n)=>{const a=this._headers.get(n);return`${r}${n.toLowerCase()}: ${a}\r
`},"")}getHash(){const e={};return this._headers.forEach((s,r)=>{e[r.toLowerCase()]=s}),e}addHeader(e,s){e=e.toUpperCase(),s=s??"";const r=this._headers.get(e);return r!==void 0&&(s=`${r}, ${s}`),this._headers.set(e,s),this}}o(E,"HeadersContainer");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class M{constructor(e,s){this._requestData=e,this._responseReceiver=s}get requestData(){return this._requestData}get requestHeaders(){return this._requestData.requestHeaders}get method(){return this._requestData.method}get url(){return this._requestData.url}get body(){return this._requestData.body}get withCredentials(){return this._requestData.withCredentials}getRequestBodySize(){return this._requestData.getRequestBodySize()}uploadProgress(e){this._responseReceiver.uploadProgress(this._requestData,e)}respond(e,s,r,n){this.setResponseHeaders(e,s,n),this.setResponseBody(r)}setResponseHeaders(e,s,r){this._responseReceiver.setResponseHeaders(this._requestData,e,s,r)}downloadProgress(e,s){this._responseReceiver.downloadProgress(this._requestData,e,s)}setResponseBody(e=null){this._responseReceiver.setResponseBody(this._requestData,e)}setNetworkError(){this._responseReceiver.setNetworkError(this._requestData)}setRequestTimeout(){this._responseReceiver.setRequestTimeout(this._requestData)}}o(M,"MockXhrRequest");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */function U(t){return t?typeof t=="string"?A(t):typeof FormData<"u"&&t instanceof FormData||t.constructor&&t.constructor.name==="FormData"?[...t.values()].reduce((e,s)=>{const r=s.size??A(String(s.toString()));return e+r},0):t.size||t.byteLength||0:0}o(U,"getBodyByteSize");function A(t){return typeof Blob<"u"?new Blob([t]).size:Buffer.byteLength(t)}o(A,"getStringByteLength");const Ce=/^[A-Za-z0-9!#$%&'*+\-.^_`|~]+$/;function W(t){return typeof t=="string"&&Ce.test(t)}o(W,"isToken");function Pe(t){return W(t)}o(Pe,"isHeaderName");function Fe(t){return typeof t=="string"&&t.trim().length===t.length&&t.indexOf("\0")===-1}o(Fe,"isHeaderValue");const Ue=["Accept-Charset","Accept-Encoding","Access-Control-Request-Headers","Access-Control-Request-Method","Connection","Content-Length","Cookie","Cookie2","Date","DNT","Expect","Host","Keep-Alive","Origin","Referer","TE","Trailer","Transfer-Encoding","Upgrade","Via"],Oe=new RegExp(`^(${Ue.join("|")}|Proxy-.*|Sec-.*)$`,"i");function Le(t){return Oe.test(t)}o(Le,"isRequestHeaderForbidden");function $e(t){return W(t)}o($e,"isRequestMethod");const Ie=/^(CONNECT|TRACE|TRACK)$/i;function Ae(t){return Ie.test(t)}o(Ae,"isRequestMethodForbidden");const xe=["DELETE","GET","HEAD","OPTIONS","POST","PUT"],Be=new RegExp(`^(${xe.join("|")})$`,"i");function H(t){return Be.test(t)&&(t=t.toUpperCase()),t}o(H,"normalizeHTTPMethodName");const ze={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",507:"Insufficient Storage",511:"Network Authentication Required"};function ke(t){return ze[t]??"Unknown Status"}o(ke,"getStatusText");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class J{constructor(e,s,r,n=null,a=!1){this._requestHeaders=e,this._method=s,this._url=r,this._body=n,this._credentialsMode=a}get requestHeaders(){return new E(this._requestHeaders)}get method(){return this._method}get url(){return this._url}get body(){return this._body}get withCredentials(){return this._credentialsMode}getRequestBodySize(){return U(this.body)}}o(J,"RequestData");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class O{constructor(e){this.type=e}}o(O,"XhrEvent");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class C extends O{constructor(e,s=0,r=0){super(e),this.loaded=s,this.total=r,this.lengthComputable=r>0}}o(C,"XhrProgressEvent");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class P{constructor(e){this._eventContext=e??this,this._listeners=new Map}get onabort(){return this._getEventHandlerProperty("abort")}set onabort(e){this._setEventHandlerProperty("abort",e)}get onerror(){return this._getEventHandlerProperty("error")}set onerror(e){this._setEventHandlerProperty("error",e)}get onload(){return this._getEventHandlerProperty("load")}set onload(e){this._setEventHandlerProperty("load",e)}get onloadend(){return this._getEventHandlerProperty("loadend")}set onloadend(e){this._setEventHandlerProperty("loadend",e)}get onloadstart(){return this._getEventHandlerProperty("loadstart")}set onloadstart(e){this._setEventHandlerProperty("loadstart",e)}get onprogress(){return this._getEventHandlerProperty("progress")}set onprogress(e){this._setEventHandlerProperty("progress",e)}get ontimeout(){return this._getEventHandlerProperty("timeout")}set ontimeout(e){this._setEventHandlerProperty("timeout",e)}hasListeners(){return[...this._listeners.values()].some(e=>e.length>0)}addEventListener(e,s,r){if(s){const n=w(s,!1,r),a=this._listeners.get(e)??[];a.every(({isEventHandlerProperty:d,listener:c,useCapture:u})=>d||n.listener!==c||n.useCapture!==u)&&(a.push(n),this._listeners.set(e,a))}}removeEventListener(e,s,r){if(s){const n=this._listeners.get(e);if(n){const a=w(s,!1,r),d=n.findIndex(({isEventHandlerProperty:c,listener:u,useCapture:l})=>!c&&a.listener===u&&a.useCapture===l);d>=0&&(n[d].removed=!0,n.splice(d,1))}}}dispatchEvent(e){const s=this._listeners.get(e.type);return s&&[...s].forEach(r=>{if(!r.removed){if(r.once){const n=s.indexOf(r);n>=0&&s.splice(n,1)}typeof r.listener=="function"?r.listener.call(this._eventContext,e):r.listener.handleEvent(e)}}),!0}_getEventHandlerProperty(e){const s=this._listeners.get(e);if(s){const r=s.find(n=>n.isEventHandlerProperty);if(r)return r.listener}return null}_setEventHandlerProperty(e,s){const r=this._listeners.get(e);if(r){const n=r.findIndex(a=>a.isEventHandlerProperty);if(n>=0){if(r[n].listener===s)return;r[n].removed=!0,r.splice(n,1)}}if(s){const n=w(s,!0);r?r.push(n):this._listeners.set(e,[n])}}}o(P,"XhrEventTarget");function w(t,e,s){const r=typeof s=="boolean";return{listener:t,isEventHandlerProperty:e,useCapture:r?s:!!(s!=null&&s.capture),once:r?!1:!!(s!=null&&s.once),removed:!1}}o(w,"makeListenerEntry");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */const Ve=["","arraybuffer","blob","document","json","text"];class i extends P{constructor(){var e;super(),this.UNSENT=i.UNSENT,this.OPENED=i.OPENED,this.HEADERS_RECEIVED=i.HEADERS_RECEIVED,this.LOADING=i.LOADING,this.DONE=i.DONE,this._authorRequestHeaders=new E,this._readyState=i.UNSENT,this._timeout=0,this._crossOriginCredentials=!1,this._uploadObject=new P(this),this.responseURL="",this._responseType="",this._response=_(),this._timeoutReference=0,this.onreadystatechange=null,this.timeoutEnabled=!0,(e=i.onCreate)==null||e.call(i,this)}get onreadystatechange(){return this._getEventHandlerProperty("readystatechange")}set onreadystatechange(e){this._setEventHandlerProperty("readystatechange",e)}get currentRequest(){return this._currentRequest}getResponseHeadersHash(){return this._response.headers.getHash()}uploadProgress(e,s){var r;if(((r=this._currentRequest)==null?void 0:r.requestData)===e){if(!this._sendFlag)throw new Error('Mock usage error detected: call send() first (the "send() flag" is not set)');if(this._uploadCompleteFlag)throw new Error('Mock usage error detected: upload already completed (the "upload complete flag" is set)');const n=e.getRequestBodySize();if(s>n)throw new Error(`Mock usage error detected: upload progress "requestBodyTransmitted" (${s}) is greater than "requestBodyLength" (${n})`);this._uploadListenerFlag&&this._fireUploadProgressEvent("progress",s,n)}}setResponseHeaders(e,s,r,n){var a;if(((a=this._currentRequest)==null?void 0:a.requestData)===e){if(!this._sendFlag)throw new Error('Mock usage error detected: call send() first (the "send() flag" is not set)');if(this._readyState!==i.OPENED)throw new Error(`Mock usage error detected: readyState is ${this._readyState}, but it must be OPENED (${i.OPENED})`);e.body&&this._processRequestEndOfBody(e.getRequestBodySize(),e.getRequestBodySize()),s=typeof s=="number"?s:200;const d=n??ke(s);this._processResponse({status:s,statusMessage:d,headers:new E(r)})}}downloadProgress(e,s,r){var n;if(((n=this._currentRequest)==null?void 0:n.requestData)===e){if(this._readyState!==i.HEADERS_RECEIVED&&this._readyState!==i.LOADING)throw new Error(`Mock usage error detected: readyState is ${this._readyState}, but it must be HEADERS_RECEIVED (${i.HEADERS_RECEIVED}) or LOADING (${i.LOADING})`);this._readyState===i.HEADERS_RECEIVED&&(this._readyState=i.LOADING),this._fireReadyStateChangeEvent(),this._fireProgressEvent("progress",s,r)}}setResponseBody(e,s){var r;if(((r=this._currentRequest)==null?void 0:r.requestData)===e){if(!this._sendFlag)throw new Error('Mock usage error detected: call send() first (the "send() flag" is not set)');if(this._readyState!==i.OPENED&&this._readyState!==i.HEADERS_RECEIVED&&this._readyState!==i.LOADING)throw new Error(`Mock usage error detected: readyState is ${this._readyState}, but it must be OPENED (${i.OPENED}), HEADERS_RECEIVED (${i.HEADERS_RECEIVED}) or LOADING (${i.LOADING})`);if(this._readyState===i.OPENED){const n={"content-length":String(U(s))};this.setResponseHeaders(e,200,n)}this._readyState=i.LOADING,this._fireReadyStateChangeEvent(),this._response.body=s??null,this._handleResponseEndOfBody()}}setNetworkError(e){var s;if(((s=this._currentRequest)==null?void 0:s.requestData)===e){if(!this._sendFlag)throw new Error('Mock usage error detected: call send() first (the "send() flag" is not set)');this._processResponse(_())}}setRequestTimeout(e){var s;if(((s=this._currentRequest)==null?void 0:s.requestData)===e){if(!this._sendFlag)throw new Error('Mock usage error detected: call send() first (the "send() flag" is not set)');if(this.timeout===0)throw new Error("Mock usage error detected: the timeout attribute must be greater than 0 for a timeout to occur");this._timedOutFlag=!0,this._terminateFetchController(),this._processResponse(_())}}get readyState(){return this._readyState}open(e,s,r){if(!r&&arguments.length>2)throw new Error("async = false is not supported.");$e(e)||m("SyntaxError",`Method "${e}" is not a method.`),Ae(e)&&m("SecurityError",`Method "${e}" forbidden.`),e=H(e),this._terminateFetchController(),this._sendFlag=!1,this._uploadListenerFlag=!1,this._requestMethod=e,this._requestUrl=s.toString(),this._authorRequestHeaders.reset(),this._response=_(),this._readyState!==i.OPENED&&(this._readyState=i.OPENED,this._fireReadyStateChangeEvent())}setRequestHeader(e,s){if((this._readyState!==i.OPENED||this._sendFlag)&&m("InvalidStateError"),typeof e!="string"||typeof s!="string")throw new SyntaxError;s=s.trim(),Pe(e)?Fe(s)||m("SyntaxError",`Value "${s}" is not a header value.`):m("SyntaxError",`Name "${e}" is not a header name.`),!Le(e)&&this._authorRequestHeaders.addHeader(e,s)}get timeout(){return this._timeout}set timeout(e){this._timeout=e,this._sendFlag&&this.timeoutEnabled&&this._getPrototype().timeoutEnabled&&this._scheduleRequestTimeout()}get withCredentials(){return this._crossOriginCredentials}set withCredentials(e){(this._readyState!==i.UNSENT&&this._readyState!==i.OPENED||this._sendFlag)&&m("InvalidStateError"),this._crossOriginCredentials=!!e}get upload(){return this._uploadObject}send(e=null){if((this._readyState!==i.OPENED||this._sendFlag)&&m("InvalidStateError"),(this._requestMethod==="GET"||this._requestMethod==="HEAD")&&(e=null),e!==null){let a=null;{let c=null;typeof e=="string"?c="text/plain;charset=UTF-8":typeof FormData<"u"&&e instanceof FormData?c="multipart/form-data; boundary=-----MochXhr1234":e.type&&(c=e.type),a=c}this._authorRequestHeaders.getHeader("Content-Type")!==null||a!==null&&this._authorRequestHeaders.addHeader("Content-Type",a)}this._uploadListenerFlag=this._uploadObject.hasListeners();const s=new J(new E(this._authorRequestHeaders),this._requestMethod,this._requestUrl,e,this._crossOriginCredentials),r=new M(s,this);if(this._uploadCompleteFlag=!1,this._timedOutFlag=!1,this._uploadCompleteFlag=r.body===null,this._sendFlag=!0,this._fireProgressEvent("loadstart",0,0),!this._uploadCompleteFlag&&this._uploadListenerFlag&&this._fireUploadProgressEvent("loadstart",0,r.getRequestBodySize()),this._readyState!==i.OPENED||!this._sendFlag)return;this._currentRequest=r,this._timeoutReference=Date.now(),this._scheduleRequestTimeout(),this._callOnSend(i.onSend);const n=this._getPrototype();n!==i&&this._callOnSend(n.onSend),this._callOnSend(this.onSend)}abort(){this._terminateFetchController(),(this._readyState===i.OPENED&&this._sendFlag||this._readyState===i.HEADERS_RECEIVED||this._readyState===i.LOADING)&&this._requestErrorSteps("abort"),this._readyState===i.DONE&&(this._readyState=i.UNSENT,this._response=_())}get status(){return this._response.status}get statusText(){return this._response.statusMessage}getResponseHeader(e){return this._response.headers.getHeader(e)}getAllResponseHeaders(){return this._response.headers.getAll()}overrideMimeType(e){(this._readyState===i.LOADING||this._readyState===i.DONE)&&m("InvalidStateError")}get responseType(){return this._responseType}set responseType(e){(this._readyState===i.LOADING||this._readyState===i.DONE)&&m("InvalidStateError"),Ve.includes(e)&&(this._responseType=e)}get response(){if(this._responseType===""||this._responseType==="text")return this._readyState!==i.LOADING&&this._readyState!==i.DONE?"":this._getTextResponse();if(this._readyState!==i.DONE)return null;if(this._responseType==="json"){if(this._response.body===null)return null;try{return JSON.parse(this._response.body)}catch{return null}}return this._response.body}get responseText(){return this._responseType!==""&&this._responseType!=="text"&&m("InvalidStateError"),this._readyState!==i.LOADING&&this._readyState!==i.DONE?"":this._getTextResponse()}get responseXML(){return this._responseType!==""&&this._responseType!=="document"&&m("InvalidStateError"),this._readyState!==i.DONE?null:this._response.body??""}_processRequestEndOfBody(e,s){this._uploadCompleteFlag=!0,this._uploadListenerFlag&&(this._fireUploadProgressEvent("progress",e,s),this._fireUploadProgressEvent("load",e,s),this._fireUploadProgressEvent("loadend",e,s))}_processResponse(e){this._response=e,this._handleErrors(),!this._response.isNetworkError&&(this._readyState=i.HEADERS_RECEIVED,this._fireReadyStateChangeEvent(),this._readyState===i.HEADERS_RECEIVED&&this._response.body===null&&this._handleResponseEndOfBody())}_handleResponseEndOfBody(){var s;if(this._handleErrors(),this._response.isNetworkError)return;const e=((s=this._response.body)==null?void 0:s.length)??0;this._fireProgressEvent("progress",e,e),this._readyState=i.DONE,this._sendFlag=!1,this._terminateFetchController(),this._fireReadyStateChangeEvent(),this._fireProgressEvent("load",e,e),this._fireProgressEvent("loadend",e,e)}_handleErrors(){this._sendFlag&&(this._timedOutFlag?this._requestErrorSteps("timeout"):this._response.isNetworkError&&this._requestErrorSteps("error"))}_requestErrorSteps(e){this._readyState=i.DONE,this._sendFlag=!1,this._response=_(),this._fireReadyStateChangeEvent(),this._uploadCompleteFlag||(this._uploadCompleteFlag=!0,this._uploadListenerFlag&&(this._fireUploadProgressEvent(e,0,0),this._fireUploadProgressEvent("loadend",0,0))),this._fireProgressEvent(e,0,0),this._fireProgressEvent("loadend",0,0)}_getTextResponse(){var e;return((e=this._response.body)==null?void 0:e.toString())??""}_callOnSend(e){if(e){const s=this._currentRequest;Promise.resolve().then(()=>e.call(s,s,this))}}_terminateFetchController(){delete this._currentRequest}_fireProgressEvent(e,s,r){this.dispatchEvent(new C(e,s,r))}_fireUploadProgressEvent(e,s,r){this._uploadObject.dispatchEvent(new C(e,s,r))}_fireReadyStateChangeEvent(){const e=new O("readystatechange");this.dispatchEvent(e)}_scheduleRequestTimeout(){if(this._timeoutTask&&clearTimeout(this._timeoutTask),this._timeout>0){const e=Math.max(0,this._timeout-(Date.now()-this._timeoutReference));this._timeoutTask=setTimeout(()=>{this._sendFlag&&this._currentRequest.setRequestTimeout(),delete this._timeoutTask},e)}}_getPrototype(){return this.constructor}}o(i,"MockXhr");i.UNSENT=0;i.OPENED=1;i.HEADERS_RECEIVED=2;i.LOADING=3;i.DONE=4;i.timeoutEnabled=!0;function m(t,e=""){const s=new Error(e);throw s.name=t,s}o(m,"throwError");function _(){return{isNetworkError:!0,status:0,statusMessage:"",headers:new E,body:null}}o(_,"makeNetworkErrorResponse");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */class Y{constructor(e,s){this.progressRate=0,this._MockXhr=e,this._requests=[],this._routes={},s&&Object.entries(s).forEach(([r,[n,a]])=>{this.addHandler(r,n,a)}),e.onSend=r=>{this._handleRequest(r)},this._xhrFactory=()=>new this._MockXhr}get MockXhr(){return this._MockXhr}get xhrMock(){return this._MockXhr}get xhrFactory(){return this._xhrFactory}install(e=globalThis){return this._savedContext=e,"XMLHttpRequest"in e?(this._savedContextHadXMLHttpRequest=!0,this._savedXMLHttpRequest=e.XMLHttpRequest):this._savedContextHadXMLHttpRequest=!1,e.XMLHttpRequest=this._MockXhr,this}remove(){if(!this._savedContext)throw new Error("remove() called without a matching install(context).");this._savedContextHadXMLHttpRequest?(this._savedContext.XMLHttpRequest=this._savedXMLHttpRequest,delete this._savedXMLHttpRequest):delete this._savedContext.XMLHttpRequest,delete this._savedContext}disableTimeout(){return this._MockXhr.timeoutEnabled=!1,this}enableTimeout(){return this._MockXhr.timeoutEnabled=!0,this}get(e,s){return this.addHandler("GET",e,s)}post(e,s){return this.addHandler("POST",e,s)}put(e,s){return this.addHandler("PUT",e,s)}delete(e,s){return this.addHandler("DELETE",e,s)}addHandler(e,s,r){return e=H(e),(this._routes[e]??(this._routes[e]=[])).push({urlMatcher:s,handler:r,count:0}),this}setDefaultHandler(e){return this._defaultRoute={handler:e,count:0},this}setDefault404(){return this.setDefaultHandler({status:404})}getRequestLog(){return[...this._requests]}_handleRequest(e){this._requests.push({method:e.method,url:e.url,headers:e.requestHeaders.getHash(),body:e.body});const s=this._findFirstMatchingRoute(e)??this._defaultRoute;if(s){const r=Array.isArray(s.handler)?s.handler[Math.min(s.handler.length-1,s.count)]:s.handler;if(s.count+=1,typeof r=="function")r(e);else if(r==="error")e.setNetworkError();else if(r==="timeout")e.setRequestTimeout();else{const n={...r.headers},a=U(r.body);if(Object.keys(n).some(d=>d.toUpperCase()==="CONTENT-LENGTH")||(n["content-length"]=String(a)),this.progressRate<=0)e.respond(r.status,n,r.body,r.statusText);else{let d=0;const c=o(()=>{if(d===0&&e.setResponseHeaders(r.status,n,r.statusText),this.progressRate<=0)e.setResponseBody(r.body);else{const l=d+this.progressRate;l<a?(d=l,e.downloadProgress(d,a),Promise.resolve().then(()=>c())):e.setResponseBody(r.body)}},"responsePhase"),u=e.getRequestBodySize();if(u===0)c();else{let l=0;const y=o(()=>{if(this.progressRate<=0)e.respond(r.status,n,r.body,r.statusText);else{const L=l+this.progressRate;L<u?(l=L,e.uploadProgress(l),Promise.resolve().then(()=>y())):c()}},"requestPhase");y()}}}}}_findFirstMatchingRoute(e){const s=H(e.method);if(!this._routes[s])return;const{url:r}=e;return this._routes[s].find(n=>{const{urlMatcher:a}=n;return typeof a=="function"?a(r):a instanceof RegExp?a.test(r):a===r})}}o(Y,"MockXhrServer");/**
 * mock-xmlhttprequest v8.2.0
 * (c) 2023 Bertrand Guay-Paquet
 * @license ISC
 */function je(){var t;return t=o(class R extends i{constructor(){var s;super(),(s=R.onCreate)==null||s.call(R,this)}},"LocalMockXhr"),t.timeoutEnabled=!0,t}o(je,"newMockXhr");function Ge(t){return new Y(je(),t)}o(Ge,"newServer");const Me=Ge({post:["/request-upload",function(t){t.uploadProgress(4096),setTimeout(()=>{t.uploadProgress(4096*5)},1e3),setTimeout(()=>{t.respond(200,{"Content-Type":"application/json"},'{"token": "12e68184-5cba-4b27-9988-609a6cc3be63"}')},2e3)}]}),b=o(({metadata:t,changed:e,...s})=>{Me.install();const r=t||{mimetype:"application/vnd.oasis.opendocument.text",size:82381,url:"./placeholder.odt",name:"test document.odt"};return Z.restore().get("/metadata/12e68184-5cba-4b27-9988-609a6cc3be63",r).post("/change-metadata/12e68184-5cba-4b27-9988-609a6cc3be63",e||200),{components:{DocumentUploader:G},setup(){return{args:s}},template:'<DocumentUploader v-bind="args" base-url="/" name="media" />'}},"UploadingServerTemplate"),T=b.bind({}),We=b.bind({});We.args={...T.args,maxSize:100*1024,mimetypes:["image/png","image/jpeg"]};const Je=b.bind({});Je.args={...T.args,automaticUpload:!1};const Ye=b.bind({});Ye.args={...T.args,values:["12e68184-5cba-4b27-9988-609a6cc3be63"]};const K=b.bind({});K.args={...T.args,values:["12e68184-5cba-4b27-9988-609a6cc3be63"],metadata:{mimetype:"image/jpeg",size:82381,url:"./placeholder.jpeg",name:"test image.jpeg"}};const Ke=b.bind({});Ke.args={...K.args,changed:400};const rt={parameters:{storySource:{source:`/*
 *
 *   OSIS stands for Open Student Information System. It's an application
 *   designed to manage the core business of higher education institutions,
 *   such as universities, faculties, institutes and professional schools.
 *   The core business involves the administration of students, teachers,
 *   courses, programs and so on.
 *
 *   Copyright (C) 2015-2021 UniversitÃ© catholique de Louvain (http://www.uclouvain.be)
 *
 *   This program is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   A copy of this license - GNU General Public License - is available
 *   at the root of the source code of this program.  If not,
 *   see http://www.gnu.org/licenses/.
 *
 */

import DocumentUploader from './DocumentUploader.vue';
import {newServer} from 'mock-xmlhttprequest';
import fetchMock from 'fetch-mock';
import type {MockResponse} from 'fetch-mock';
import type {Meta, StoryFn} from "@storybook/vue3";
import type {FileUpload} from "./interfaces";

// XMLHttpRequest mock
const mockXhrServer = newServer({
  post: ['/request-upload', function (xhr) {
    xhr.uploadProgress(4096);
    setTimeout(() => {
      xhr.uploadProgress(4096 * 5);
    }, 1000);
    setTimeout(() => {
      xhr.respond(
          200,
          {'Content-Type': 'application/json'},
          '{"token": "12e68184-5cba-4b27-9988-609a6cc3be63"}',
      );
    }, 2000);
  }],
});

const UploadingServerTemplate: StoryFn<typeof DocumentUploader & { metadata: FileUpload | MockResponse, changed: MockResponse }> = (
    {metadata, changed, ...args},
) => {
  mockXhrServer.install();
  const documentMetadata = metadata || {
    mimetype: 'application/vnd.oasis.opendocument.text',
    size: 82381,
    url: './placeholder.odt',
    name: 'test document.odt',
  };
  fetchMock
      .restore()
      .get('/metadata/12e68184-5cba-4b27-9988-609a6cc3be63', documentMetadata)
      .post('/change-metadata/12e68184-5cba-4b27-9988-609a6cc3be63', changed || 200);

  return ({
    components: {DocumentUploader},
    setup() {
      return {args};
    },
    template: '<DocumentUploader v-bind="args" base-url="/" name="media" />',
  });
};

export const Basic = UploadingServerTemplate.bind({});

export const Limited = UploadingServerTemplate.bind({});
Limited.args = {
  ...Basic.args,
  maxSize: 100 * 1024,
  mimetypes: ['image/png', 'image/jpeg'],
};

export const ManualTrigger = UploadingServerTemplate.bind({});
ManualTrigger.args = {
  ...Basic.args,
  automaticUpload: false,
};

export const WithExistingValue = UploadingServerTemplate.bind({});
WithExistingValue.args = {
  ...Basic.args,
  values: ['12e68184-5cba-4b27-9988-609a6cc3be63'],
};

export const EditableImage = UploadingServerTemplate.bind({});
EditableImage.args = {
  ...Basic.args,
  values: ['12e68184-5cba-4b27-9988-609a6cc3be63'],
  metadata: {
    mimetype: 'image/jpeg',
    size: 82381,
    url: './placeholder.jpeg',
    name: 'test image.jpeg',
  },
};

export const EditableImageWithError = UploadingServerTemplate.bind({});
EditableImageWithError.args = {
  ...EditableImage.args,
  changed: 400,
};

export default {
  title: 'DocumentUploader',
  component: DocumentUploader,
} as Meta<typeof DocumentUploader>;
`,locationsMap:{basic:{startLoc:{col:131,line:51},endLoc:{col:1,line:73},startBody:{col:131,line:51},endBody:{col:1,line:73}},limited:{startLoc:{col:131,line:51},endLoc:{col:1,line:73},startBody:{col:131,line:51},endBody:{col:1,line:73}},"manual-trigger":{startLoc:{col:131,line:51},endLoc:{col:1,line:73},startBody:{col:131,line:51},endBody:{col:1,line:73}},"with-existing-value":{startLoc:{col:131,line:51},endLoc:{col:1,line:73},startBody:{col:131,line:51},endBody:{col:1,line:73}},"editable-image":{startLoc:{col:131,line:51},endLoc:{col:1,line:73},startBody:{col:131,line:51},endBody:{col:1,line:73}},"editable-image-with-error":{startLoc:{col:131,line:51},endLoc:{col:1,line:73},startBody:{col:131,line:51},endBody:{col:1,line:73}}}}},title:"DocumentUploader",component:G},nt=["Basic","Limited","ManualTrigger","WithExistingValue","EditableImage","EditableImageWithError"];export{T as Basic,K as EditableImage,Ke as EditableImageWithError,We as Limited,Je as ManualTrigger,Ye as WithExistingValue,nt as __namedExportsOrder,rt as default};
//# sourceMappingURL=DocumentUploader.stories-7a47d109.js.map
